#!/usr/bin/env python
# encoding: utf-8

import sys
import os
import csv
import string

def main():
	d = 4

	width = 100
	rowHeight = 10
	rowSpacer = 1
	minWidth = 4

	labels = { }
	timevals = { }
	startTime = -1
	endTime = -1
	totalTime = 0

	#possibleColors = ['red', 'green', 'blue', 'yellow', 'orange']
	colors = 'red green blue cyan magenta yellow black gray darkgray lightgray brown lime olive orange pink purple teal violet'
	possibleColors = colors.split(' ')
	myColorMap = {}
	#skipTypes
	#path = 'swimFile4RedNy2V2/timelog/'
	path = 'swimFilesv3/'
	
	for di in range(0,d):
		with open(path +str(di)+'.0', 'rb') as tf:
			labels[di] = []
			timevals[di] = []
			for line in tf:
				#line = line.replace("Start first pass of block", "First Pass of Block Begin").replace("End first pass of block", "First Pass of Block End")
				line = line.replace("Start first pass of block", "First pass of block Begin").replace("End first pass of block", "First pass of block End")
				pieces = line.split(':')
				labels[di].append(pieces[0].strip())
				timevals[di].append(int(pieces[1].strip()))
		if startTime < 0 or startTime > timevals[di][0]:
			startTime = timevals[di][0]
		if endTime < 0 or endTime < timevals[di][len(timevals[di])-1]:
			endTime = timevals[di][len(timevals[di])-1]

	totalTime = endTime - startTime


	# print out latex/tikz preamble here
	print "\\documentclass{article}"
	print "\\usepackage{tikz}"
	print "\\usetikzlibrary{arrows,positioning}"
	print "\\begin{document}"
	print "\\begin{figure}"
	print "\\centering"
	#print "\\begin{tikzpicture}[node distance=1cm, auto]"
	print "\\begin{tikzpicture}[scale=0.15]"

	for di in range(0,d):
		dlabel = labels[di]
		dtimes = timevals[di]
		#print labels[di]
		#print dlabel

		print ' '


		inside=False
		i = 0
		while True:
			if i+1 >= len(dlabel):
				break

			rectTop = di * (rowHeight + rowSpacer)
			rectBottom = rectTop + rowHeight

			labelkey = dlabel[i].replace('Begin','').replace('End','').strip()
			j = i+1
			if dlabel[i].strip() == 'Time Waiting Sync Write Begin':
				j = i
				while labelkey != (dlabel[j+1].replace('Begin','').replace('End','').strip()): 
					j = j + 1
				j = j+1
				inside=True

			if dlabel[i].strip() == 'Time Waiting Sync Write  End':
				inside=False
				i = i+1
				continue

			labelkey2 = dlabel[j].replace('Begin','').replace('End','').strip()

			if labelkey == labelkey2: # and 'Begin' in dlabel[i] and 'End' in dlabel[i+1]:
				while labelkey == (dlabel[j+1].replace('Begin','').replace('End','').strip()):
					j = j + 1
					#print "% More " + str(j)

				rectStart = 1.0 * (dtimes[i] - startTime)/totalTime * width
				rectEnd =  1.0 * (dtimes[j] - startTime)/totalTime * width 


				if labelkey in myColorMap:
					curColor = myColorMap[labelkey]
				else:
					#print possibleColors
					curColor = possibleColors.pop()
					myColorMap[labelkey] = curColor

				if inside and labelkey != 'Time Waiting Sync Write':
					rectTop = rectTop + rowSpacer
					rectBottom = rectBottom - rowSpacer

				#if rectEnd-rectStart > minWidth:
				#print '\\filldraw[fill=' + str(curColor) + ',draw=black,opacity=0.2] ('+str(rectStart)+','+str(rectTop)+') rectangle ('+str(rectEnd)+','+str(rectBottom)+');'
				print '% ' + labelkey + ': ' + str((dtimes[j]-dtimes[i])/1000)
				print '\\filldraw[fill=' + str(curColor) + ',draw=black,opacity=0.2] ('+("{0:.10f}".format(rectStart))+','+str(rectTop)+') rectangle ('+("{0:.10f}".format(rectEnd))+','+str(rectBottom)+');'
					# print rectangle with rectTop, rectBottom, rectStart, rectEnd
					# color should be curColor

				if labelkey == 'Time Waiting Sync Write': 
					i = i + 1
				else: 
					i = j + 1
				continue
			else:
				i = i+1
				continue
		


	print "\\end{tikzpicture}"
	#print "\\medskip"
	#print "\\caption{Structure of the Market} "
	print "\\end{figure}"
	print "\\end{document}"



				
	# print out latex/tikz closing here

if __name__ == '__main__':
	main()




